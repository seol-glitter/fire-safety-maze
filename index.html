<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>화재 대피 미로 게임</title>
<style>
  html,body{height:100%;margin:0;background:#0b1220;color:#e6f4ff;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif}
  .wrap{min-height:100%;display:grid;place-items:center;padding:18px}
  .board{position:relative;width:min(96vw,1200px);height:64vh;background:#0f172a;border-radius:18px;overflow:hidden;box-shadow:0 14px 36px rgba(0,0,0,.35)}
  canvas{width:100%;height:100%;display:block;touch-action:none}
  #player{position:absolute;left:0;top:0;width:10.8%;aspect-ratio:1/1;background:url('./running.png') center/contain no-repeat;transform:translate(-50%,-50%);filter:drop-shadow(0 6px 10px rgba(0,0,0,.35));z-index:10;cursor:grab;touch-action:none}
  .hud{margin-top:12px}
  .btn{display:inline-block;margin-left:8px;padding:8px 12px;border-radius:10px;background:#16a34a;color:#fff;text-decoration:none;font-weight:800}
  .ghost{background:#334155}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:50}
  .card{width:min(92vw,460px);background:#0f172a;border:1px solid #1f2937;border-radius:16px;padding:20px 18px;box-shadow:0 12px 32px rgba(0,0,0,.45)}
  .card h2{margin:6px 0 10px;font-size:20px}
  .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
</style>
</head>
<body>
<div class="wrap">
  <div class="board" id="board">
    <canvas id="maze"></canvas>
    <div id="player" aria-label="달리는 주인공"></div>
  </div>
  <div class="hud" aria-live="polite">
    <span id="status">EXIT 0회 통과</span>
    <a id="retry" class="btn ghost" href="#">처음으로</a>
  </div>
</div>

<div class="modal" id="finishModal" role="dialog" aria-modal="true" aria-labelledby="finishTitle">
  <div class="card">
    <h2 id="finishTitle">성공! 안전하게 도착했어요 🎉</h2>
    <p>다시 할까요? 또는 다음 단계로 진행할 수 있어요.</p>
    <div class="actions">
      <button class="btn ghost" id="btnAgain">처음부터</button>
      <button class="btn" id="btnNext">다음 단계</button>
    </div>
  </div>
</div>

<script>
const qs   = new URLSearchParams(location.search);
const TK   = qs.get('tk')   || '';
const MODE = (qs.get('mode')||'b').toLowerCase();
const PROB = qs.get('problem') || '04_비상구로대피';
const RET  = qs.get('ret')  || '';
let LEVEL  = Number(qs.get('level')||1);

function onGameSuccess(){
  const q = new URLSearchParams({ tk:TK, mode:MODE, problem:PROB, ret:RET });
  location.replace('https://seol-glitter.github.io/teacherhome/handoff.html?' + q.toString());
}

const FILES = {
  level1_bg: "./maze1,exit.png",
  level2_bg: "./maze2,exit.png",
  sound: "./정답sound.wav"
};

const board  = document.getElementById('board');
const canvas = document.getElementById('maze');
const ctx    = canvas.getContext('2d', { willReadFrequently: true });
const player = document.getElementById('player');
const statusEl = document.getElementById('status');
const retry  = document.getElementById('retry');
const modal  = document.getElementById('finishModal');
const btnAgain = document.getElementById('btnAgain');
const btnNext  = document.getElementById('btnNext');

const bgImg = new Image();
let dragging=false, dx=0, dy=0, gameOver=false;
let xRatio, yRatio;
let exitHits = 0;
let hotSpots = [];
let goalZone = null;

function playCorrect(){
  try{
    const a = new Audio(FILES.sound);
    a.volume = 1.0;
    a.play().catch(()=>{});
  }catch(e){}
}

const LV = {
  1: { bg: FILES.level1_bg, start:{x:0.06,y:0.88},
       hot:[ {x:0.22,y:0.42,w:0.08,h:0.12}, {x:0.48,y:0.22,w:0.08,h:0.12},
             {x:0.62,y:0.58,w:0.08,h:0.12}, {x:0.38,y:0.72,w:0.08,h:0.12} ],
       goal:{x:0.92,y:0.10,w:0.08,h:0.12}, need:0 },
  2: { bg: FILES.level2_bg, start:{x:0.06,y:0.86},
       hot:[ {x:0.28,y:0.38,w:0.08,h:0.12}, {x:0.53,y:0.30,w:0.08,h:0.12},
             {x:0.66,y:0.48,w:0.08,h:0.12}, {x:0.84,y:0.72,w:0.08,h:0.12} ],
       goal:{x:0.94,y:0.12,w:0.08,h:0.12}, need:3 }
};

function setLevel(n){
  LEVEL = n;
  const cfg = LV[n];
  bgImg.src = cfg.bg;
  xRatio = cfg.start.x; yRatio = cfg.start.y;
  hotSpots = cfg.hot.map(o=>({...o, hit:false}));
  goalZone = {...cfg.goal};
  exitHits = 0; gameOver=false;
  statusEl.textContent = `EXIT ${exitHits}회 통과` + (LEVEL===2?' — 3회 이상 후 골 도착':'');
  resize();
}
bgImg.onload = ()=>{ draw(); updatePlayerPos(); };
window.addEventListener('resize', resize);
setLevel(LEVEL);

function resize(){
  const r = board.getBoundingClientRect();
  canvas.width = r.width;
  canvas.height = r.height;
  draw(); updatePlayerPos();
}
function draw(){
  if(!bgImg.complete) return;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
}

function updatePlayerPos(){
  const r = board.getBoundingClientRect();
  const x = xRatio * canvas.width;
  const y = yRatio * canvas.height;
  player.style.left = (r.left + x) + 'px';
  player.style.top  = (r.top  + y) + 'px';
}
function rectsOverlap(a,b){ return !(a.x+a.w < b.x || b.x+b.w < a.x || a.y+a.h < b.y || b.y+b.h < a.y); }
function worldRect(px,py,pw,ph){ return { x:px*canvas.width, y:py*canvas.height, w:pw*canvas.width, h:ph*canvas.height }; }
function canMove(checkX, checkY){
  const cx = Math.round(checkX), cy = Math.round(checkY);
  if (cx<0||cy<0||cx>=canvas.width||cy>=canvas.height) return false;
  const d = ctx.getImageData(cx, cy, 1, 1).data;
  return (d[0]>240 && d[1]>240 && d[2]>240);
}
function moveTowards(clientX, clientY){
  if(gameOver) return;
  const boardRect = board.getBoundingClientRect();
  const targetX = clientX - boardRect.left;
  const targetY = clientY - boardRect.top;
  const curX = xRatio * canvas.width;
  const curY = yRatio * canvas.height;
  const steps = 40;
  const dx = (targetX - curX)/steps;
  const dy = (targetY - curY)/steps;
  let nx = curX, ny = curY;
  for(let i=0;i<steps;i++){
    const tx = nx + dx, ty = ny + dy;
    if(!canMove(tx, ty)) break;
    nx = tx; ny = ty;
  }
  xRatio = nx / canvas.width; yRatio = ny / canvas.height;
  updatePlayerPos();
  afterMove();
}

function afterMove(){
  const bb = player.getBoundingClientRect();
  const br = {x:bb.left - board.getBoundingClientRect().left, y:bb.top - board.getBoundingClientRect().top, w:bb.width, h:bb.height};

  hotSpots.forEach(s=>{
    if(!s.hit){
      const r = worldRect(s.x, s.y, s.w, s.h);
      if(rectsOverlap(br, r)){ s.hit = true; exitHits++; playCorrect();
        statusEl.textContent = `EXIT ${exitHits}회 통과` + (LEVEL===2?' — 3회 이상 후 골 도착':'');
      }
    }
  });

  const g = worldRect(goalZone.x, goalZone.y, goalZone.w, goalZone.h);
  if(rectsOverlap(br, g)){
    if(LEVEL===1){ gameOver=true; showFinishModal(); }
    else{ if(exitHits >= LV[2].need) onGameSuccess();
          else statusEl.textContent = `EXIT ${exitHits}회 통과 — 3회 이상 지나가면 탈출!`; }
  }
}

function showFinishModal(){ modal.style.display='flex'; btnAgain.focus(); }
btnAgain.addEventListener('click', ()=>{ modal.style.display='none'; setLevel(1); });
btnNext.addEventListener('click',   ()=>{
  modal.style.display='none'; setLevel(2);
  const url = new URL(location.href); url.searchParams.set('level','2'); history.replaceState(null,'',url);
});
retry.addEventListener('click', e=>{ e.preventDefault(); setLevel(1); });

function onDown(ev){
  if(gameOver) return;
  const e = ev.touches? ev.touches[0] : ev;
  const pr = player.getBoundingClientRect();
  dx = e.clientX - pr.left; dy = e.clientY - pr.top;
  player.style.cursor='grabbing';
  window.addEventListener('pointermove', onMove, {passive:false});
  window.addEventListener('pointerup', onUp, {once:true});
}
function onMove(ev){ moveTowards(ev.clientX, ev.clientY); }
function onUp(){ player.style.cursor='grab'; window.removeEventListener('pointermove', onMove); }
player.addEventListener('pointerdown', onDown);

if (bgImg.complete) { draw(); updatePlayerPos(); }
</script>
</body>
</html>
