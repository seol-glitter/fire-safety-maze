<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>화재 대피 미로 게임</title>
<style>
  body { margin:0; display:flex; justify-content:center; align-items:center; background:#eee; }
  #container { position:relative; }
  #gameCanvas { border:3px solid black; touch-action:none; }
  #player, #exit {
    position:absolute;
    background-size:contain;
    background-repeat:no-repeat;
  }
  #player { width:50px; height:50px; background-image:url("running.png"); }
  #exit   { width:60px; height:60px; background-image:url("exit.png"); top:420px; left:820px; }
</style>
</head>
<body>
<div id="container">
  <canvas id="gameCanvas" width="902" height="487"></canvas>
  <div id="player" style="top:10px; left:10px;"></div>
  <div id="exit"></div>
</div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const mazeImg = new Image();
mazeImg.src = "maze.jpg"; // fire 포함된 미로 배경

const player = document.getElementById("player");
const exit = document.getElementById("exit");
let dragging = false, offsetX, offsetY;
let x = 10, y = 10;

mazeImg.onload = () => {
  ctx.drawImage(mazeImg, 0, 0, canvas.width, canvas.height);
};

function canMove(newX, newY) {
  const cx = newX + player.offsetWidth/2;
  const cy = newY + player.offsetHeight/2;
  const pixel = ctx.getImageData(cx, cy, 1, 1).data;

  // 하얀색 통과 (RGB 모두 240 이상), 나머지는 불가
  if (pixel[0] > 240 && pixel[1] > 240 && pixel[2] > 240) {
    return true; // 길
  }
  return false; // 벽 + fire
}

function movePlayer(newX, newY) {
  if (newX < 0 || newY < 0 || 
      newX > canvas.width - player.offsetWidth || 
      newY > canvas.height - player.offsetHeight) return;

  if (canMove(newX, newY)) {
    x = newX; y = newY;
    player.style.left = x + "px";
    player.style.top = y + "px";

    const pRect = player.getBoundingClientRect();
    const eRect = exit.getBoundingClientRect();
    if (!(pRect.right < eRect.left || pRect.left > eRect.right ||
          pRect.bottom < eRect.top || pRect.top > eRect.bottom)) {
      alert("성공! 안전하게 도착했어요!");
    }
  }
}

// 마우스 드래그
player.addEventListener("mousedown", e => {
  dragging = true;
  offsetX = e.clientX - player.offsetLeft;
  offsetY = e.clientY - player.offsetTop;
});
document.addEventListener("mousemove", e => {
  if (!dragging) return;
  movePlayer(e.clientX - offsetX, e.clientY - offsetY);
});
document.addEventListener("mouseup", () => dragging = false);

// 터치 드래그
player.addEventListener("touchstart", e => {
  dragging = true;
  offsetX = e.touches[0].clientX - player.offsetLeft;
  offsetY = e.touches[0].clientY - player.offsetTop;
});
document.addEventListener("touchmove", e => {
  if (!dragging) return;
  movePlayer(e.touches[0].clientX - offsetX, e.touches[0].clientY - offsetY);
});
document.addEventListener("touchend", () => dragging = false);
</script>
</body>
</html>
