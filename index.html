<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>화재 대피 미로 게임</title>
<style>
  body { margin:0; display:flex; justify-content:center; align-items:center; background:#eee; height:100vh; }
  #container { position:relative; width:100%; height:100%; max-width:100vw; max-height:100vh; }
  #gameCanvas { width:100%; height:100%; display:block; }
  #player, #exit {
    position:absolute;
    background-size:contain;
    background-repeat:no-repeat;
  }
  #player { width:8vw; height:8vw; background-image:url("running.png"); }
  #exit   { width:10vw; height:10vw; background-image:url("exit.png"); }
</style>
</head>
<body>
<div id="container">
  <canvas id="gameCanvas"></canvas>
  <div id="player"></div>
  <div id="exit"></div>
</div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const mazeImg = new Image();
mazeImg.src = "maze.jpg";

const player = document.getElementById("player");
const exit = document.getElementById("exit");

let dragging = false, offsetX, offsetY;
let x=20, y=20;
let canvasWidth, canvasHeight;

function resizeCanvas() {
  canvasWidth = window.innerWidth;
  canvasHeight = window.innerHeight;
  canvas.width = canvasWidth;
  canvas.height = canvasHeight;
  ctx.drawImage(mazeImg, 0, 0, canvasWidth, canvasHeight);

  // 플레이어 초기 위치
  player.style.left = x + "px";
  player.style.top = y + "px";
  // 출구 위치 (화면 오른쪽 아래로 비율 배치)
  exit.style.left = (canvasWidth*0.85) + "px";
  exit.style.top = (canvasHeight*0.85) + "px";
}

mazeImg.onload = resizeCanvas;
window.addEventListener("resize", resizeCanvas);

function canMove(newX, newY) {
  const cx = newX + player.offsetWidth/2;
  const cy = newY + player.offsetHeight/2;
  const pixel = ctx.getImageData(cx, cy, 1, 1).data;

  // 하얀색 길만 통과 가능
  return (pixel[0] > 240 && pixel[1] > 240 && pixel[2] > 240);
}

function movePlayer(newX, newY) {
  if (newX < 0 || newY < 0 ||
      newX > canvasWidth - player.offsetWidth ||
      newY > canvasHeight - player.offsetHeight) return;

  if (canMove(newX, newY)) {
    x = newX; y = newY;
    player.style.left = x + "px";
    player.style.top = y + "px";

    // 출구 도착 체크
    const pRect = player.getBoundingClientRect();
    const eRect = exit.getBoundingClientRect();
    if (!(pRect.right < eRect.left || pRect.left > eRect.right ||
          pRect.bottom < eRect.top || pRect.top > eRect.bottom)) {
      alert("성공! 안전하게 도착했어요!");
    }
  }
}

// 마우스
player.addEventListener("mousedown", e=>{
  dragging = true;
  offsetX = e.clientX - player.offsetLeft;
  offsetY = e.clientY - player.offsetTop;
});
document.addEventListener("mousemove", e=>{
  if (!dragging) return;
  movePlayer(e.clientX - offsetX, e.clientY - offsetY);
});
document.addEventListener("mouseup", ()=> dragging=false);

// 터치
player.addEventListener("touchstart", e=>{
  dragging = true;
  offsetX = e.touches[0].clientX - player.offsetLeft;
  offsetY = e.touches[0].clientY - player.offsetTop;
});
document.addEventListener("touchmove", e=>{
  if (!dragging) return;
  movePlayer(e.touches[0].clientX - offsetX, e.touches[0].clientY - offsetY);
});
document.addEventListener("touchend", ()=> dragging=false);
</script>
</body>
</html>
